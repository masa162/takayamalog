# 高山まさあきの夜遊び研究所\_設計書v1.0

## 目次

1. [プロジェクト概要](#プロジェクト概要)
2. [サイト基本設計](#サイト基本設計)
3. [技術アーキテクチャ](#技術アーキテクチャ)
4. [データベース設計](#データベース設計)
5. [法的コンプライアンス](#法的コンプライアンス)
6. [コンテンツ管理システム](#コンテンツ管理システム)
7. [アフィリエイト連携システム](#アフィリエイト連携システム)
8. [SEO・アクセシビリティ](#seoアクセシビリティ)
9. [セキュリティ・パフォーマンス](#セキュリティパフォーマンス)
10. [デプロイメント・インフラ](#デプロイメントインフラ)
11. [運用・保守計画](#運用保守計画)
12. [開発ロードマップ](#開発ロードマップ)
13. [実装ガイドライン](#実装ガイドライン)
14. [品質保証・テスト](#品質保証テスト)
15. [監視・分析](#監視分析)

---

## プロジェクト概要

### 基本情報

- **プロジェクト名**: 高山まさあきの夜遊び研究所
- **ドメイン**: takayamalog.com
- **GitHubリポジトリ**: https://github.com/masa162/takayamalog
- **サイトタイプ**: 個人ブランド型アダルトコンテンツサイト
- **主要コンテンツ**: 風俗体験談、FANZA動画レビュー

### プロジェクトビジョン

風俗ライター・高山まさあきの個人ブランドを確立し、実体験に基づく信頼できる情報を「研究成果」として提供する読み物サイトを構築する。

### 核心価値

1. **信頼性**: 実体験に基づく正確な情報
2. **エンターテイメント性**: 読み物としての楽しさ
3. **専門性**: 8年間の業界経験に基づく知見
4. **親しみやすさ**: 研究所という設定による知的好奇心の刺激

### ターゲットオーディエンス

- **プライマリー**: 35-45歳男性（アラフォー）
- **セカンダリー**: 30-34歳男性、46-55歳男性
- **特徴**: 実体験に基づく情報を求める、読み物を楽しむ、エンターテイメント性を重視

### 成功指標

- **短期（3ヶ月）**: 月間10,000PV、記事30本公開
- **中期（6ヶ月）**: 月間30,000PV、月収30万円、記事60本
- **長期（12ヶ月）**: 月間100,000PV、月収100万円、記事100本

---

## サイト基本設計

### サイト構造

```
高山まさあきの夜遊び研究所 (takayamalog.com)
├── トップページ
│   ├── ヒーロセクション
│   ├── 最新研究成果（新着記事）
│   ├── カテゴリ別研究成果
│   └── 研究所について
├── 研究成果一覧
│   ├── 風俗体験談
│   │   ├── 店舗型風俗
│   │   ├── デリヘル
│   │   └── 出会い系・マッチング
│   ├── FANZA動画レビュー
│   │   ├── 新作レビュー
│   │   ├── 女優特集
│   │   └── ジャンル別分析
│   └── 業界研究
│       ├── トレンド分析
│       ├── 市場調査
│       └── 統計データ
├── 研究所案内
│   ├── 所長プロフィール
│   ├── 研究方針
│   ├── 実績・経歴
│   └── お問い合わせ
└── ユーティリティ
    ├── 年齢確認
    ├── 利用規約
    ├── プライバシーポリシー
    └── サイトマップ
```

### コンテンツ戦略

#### 50:50の黄金比

- **風俗体験談**: 50%
  - 店舗型風俗体験談
  - デリヘル体験談
  - 出会い系・マッチングアプリ体験談
- **FANZA動画レビュー**: 50%
  - 新作動画レビュー
  - 女優特集記事
  - ジャンル別分析記事

#### 研究所らしいコンテンツ設計

- **研究報告書形式**: 客観的データと主観的考察の組み合わせ
- **実験的アプローチ**: 「検証してみた」「比較してみた」系コンテンツ
- **データ分析**: 統計情報を交えた分析記事
- **長期追跡調査**: 同じ店舗・作品の継続的な観察記事

### ブランディング戦略

#### 「研究所」というキャラクター設定

- **所長**: 高山まさあき
- **研究テーマ**: 大人の夜遊び文化
- **研究手法**: 実体験に基づく参与観察
- **研究成果**: 体験談・レビュー記事

#### トーン&マナー

- **知的好奇心**: 学術的なアプローチ
- **客観性**: 冷静で公正な分析
- **ユーモア**: 適度な遊び心
- **親しみやすさ**: 堅すぎない表現

---

## 技術アーキテクチャ

### 技術スタック概要

```
Frontend: Next.js 14 (App Router)
Backend: Supabase (PostgreSQL + Auth + Storage)
Hosting: Vercel
Domain: takayamalog.com (Namecheap)
Styling: Tailwind CSS
Analytics: Google Analytics 4
```

### Next.js 14 構成

#### App Router構造

```
src/
├── app/
│   ├── layout.tsx              # Root Layout
│   ├── page.tsx                # Home Page
│   ├── globals.css             # Global Styles
│   ├── loading.tsx             # Loading UI
│   ├── error.tsx               # Error UI
│   ├── not-found.tsx           # 404 Page
│   ├── age-verification/       # 年齢確認
│   │   └── page.tsx
│   ├── fuzoku/                 # 風俗体験談
│   │   ├── page.tsx
│   │   ├── [slug]/
│   │   │   └── page.tsx
│   │   └── category/
│   │       └── [category]/
│   │           └── page.tsx
│   ├── fanza/                  # FANZA動画レビュー
│   │   ├── page.tsx
│   │   ├── [slug]/
│   │   │   └── page.tsx
│   │   └── category/
│   │       └── [category]/
│   │           └── page.tsx
│   ├── about/                  # 研究所について
│   │   └── page.tsx
│   ├── contact/                # お問い合わせ
│   │   └── page.tsx
│   └── api/                    # API Routes
│       ├── articles/
│       ├── auth/
│       └── affiliate/
├── components/
│   ├── ui/                     # 基本UIコンポーネント
│   ├── layout/                 # レイアウトコンポーネント
│   ├── content/                # コンテンツコンポーネント
│   └── features/               # 機能別コンポーネント
├── lib/
│   ├── supabase/               # Supabase関連
│   ├── utils/                  # ユーティリティ
│   └── hooks/                  # カスタムフック
├── types/                      # TypeScript型定義
└── styles/                     # スタイル関連
```

### Supabase設定

#### 認証システム

```typescript
// /lib/supabase/client.ts
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs'
import { Database } from '@/types/database.types'

export const supabase = createClientComponentClient<Database>()
```

#### サーバーサイド設定

```typescript
// /lib/supabase/server.ts
import { createServerComponentClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'
import { Database } from '@/types/database.types'

export const createServerSupabaseClient = () => {
  const cookieStore = cookies()
  return createServerComponentClient<Database>({ cookies: () => cookieStore })
}
```

### セキュリティ設定

#### 重要なセキュリティ対策

1. **CVE-2025-29927対応**: Next.js 14.2.25以降を使用
2. **環境変数管理**: 機密情報の適切な分離
3. **CORS設定**: 適切なオリジン制限
4. **Rate Limiting**: API呼び出し制限

#### 環境変数構成

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# Analytics
NEXT_PUBLIC_GA_ID=your_ga_id

# FANZA API
FANZA_API_ID=your_fanza_api_id
FANZA_AFFILIATE_ID=your_fanza_affiliate_id

# 年齢確認
NEXT_PUBLIC_AGE_VERIFICATION_ENABLED=true
```

---

## データベース設計

### Supabase PostgreSQL スキーマ

#### 記事管理テーブル

```sql
-- 記事テーブル
CREATE TABLE articles (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    slug VARCHAR(255) UNIQUE NOT NULL,
    content TEXT NOT NULL,
    excerpt VARCHAR(500),
    category_id UUID REFERENCES categories(id),
    tags TEXT[],
    status VARCHAR(20) DEFAULT 'draft',
    published_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    -- SEO関連
    meta_title VARCHAR(60),
    meta_description VARCHAR(160),
    og_image_url TEXT,

    -- 統計情報
    view_count INTEGER DEFAULT 0,
    like_count INTEGER DEFAULT 0,
    share_count INTEGER DEFAULT 0,

    -- 記事固有情報
    article_type VARCHAR(20) NOT NULL, -- 'fuzoku', 'fanza', 'research'
    rating DECIMAL(2,1),

    -- 研究所らしい項目
    research_method TEXT,
    research_period VARCHAR(50),
    research_budget INTEGER,

    -- インデックス
    CONSTRAINT articles_rating_check CHECK (rating >= 0 AND rating <= 5)
);

-- カテゴリテーブル
CREATE TABLE categories (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    parent_id UUID REFERENCES categories(id),
    sort_order INTEGER DEFAULT 0,
    article_type VARCHAR(20) NOT NULL, -- 'fuzoku', 'fanza', 'research'
    color VARCHAR(7) DEFAULT '#6B7280', -- ブランドカラー
    icon VARCHAR(50),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 風俗店舗情報テーブル
CREATE TABLE establishments (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    type VARCHAR(50) NOT NULL, -- 'soap', 'health', 'delivery'
    area VARCHAR(100),
    address TEXT,
    phone VARCHAR(20),
    website_url TEXT,
    price_range VARCHAR(100),
    business_hours TEXT,
    services TEXT[],
    rating DECIMAL(2,1),
    visit_count INTEGER DEFAULT 0,
    last_visit_date DATE,
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- FANZA作品情報テーブル
CREATE TABLE fanza_works (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    fanza_id VARCHAR(50) UNIQUE NOT NULL,
    title VARCHAR(255) NOT NULL,
    actress_name VARCHAR(255),
    director VARCHAR(255),
    genre VARCHAR(100),
    release_date DATE,
    duration INTEGER, -- 分
    fanza_url TEXT,
    thumbnail_url TEXT,
    price INTEGER,
    rating DECIMAL(2,1),
    review_count INTEGER DEFAULT 0,
    last_checked_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 記事と店舗の関連テーブル
CREATE TABLE article_establishments (
    article_id UUID REFERENCES articles(id) ON DELETE CASCADE,
    establishment_id UUID REFERENCES establishments(id) ON DELETE CASCADE,
    PRIMARY KEY (article_id, establishment_id)
);

-- 記事とFANZA作品の関連テーブル
CREATE TABLE article_fanza_works (
    article_id UUID REFERENCES articles(id) ON DELETE CASCADE,
    fanza_work_id UUID REFERENCES fanza_works(id) ON DELETE CASCADE,
    PRIMARY KEY (article_id, fanza_work_id)
);

-- アクセス統計テーブル
CREATE TABLE page_views (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    article_id UUID REFERENCES articles(id) ON DELETE CASCADE,
    ip_address INET,
    user_agent TEXT,
    referer TEXT,
    country VARCHAR(2),
    city VARCHAR(100),
    viewed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    session_id UUID,
    is_unique_view BOOLEAN DEFAULT true
);

-- アフィリエイトクリック統計テーブル
CREATE TABLE affiliate_clicks (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    article_id UUID REFERENCES articles(id) ON DELETE CASCADE,
    affiliate_type VARCHAR(20) NOT NULL, -- 'fanza', 'establishment', 'other'
    affiliate_id VARCHAR(100),
    clicked_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    ip_address INET,
    user_agent TEXT,
    referer TEXT,
    converted BOOLEAN DEFAULT false,
    conversion_value DECIMAL(10,2)
);
```

#### Row Level Security (RLS) 設定

```sql
-- 記事テーブルのRLS
ALTER TABLE articles ENABLE ROW LEVEL SECURITY;

-- 公開記事のみ閲覧可能
CREATE POLICY "Articles are viewable by everyone when published"
ON articles FOR SELECT
USING (status = 'published');

-- 管理者のみ編集可能
CREATE POLICY "Articles are editable by admin only"
ON articles FOR ALL
USING (auth.jwt() ->> 'role' = 'admin');

-- 統計情報のRLS
ALTER TABLE page_views ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Page views are readable by admin only"
ON page_views FOR ALL
USING (auth.jwt() ->> 'role' = 'admin');
```

### データベース最適化

#### インデックス設定

```sql
-- 記事検索用インデックス
CREATE INDEX idx_articles_published ON articles(published_at) WHERE status = 'published';
CREATE INDEX idx_articles_category ON articles(category_id);
CREATE INDEX idx_articles_type ON articles(article_type);
CREATE INDEX idx_articles_rating ON articles(rating);

-- 全文検索用インデックス
CREATE INDEX idx_articles_search ON articles USING GIN(to_tsvector('japanese', title || ' ' || excerpt || ' ' || content));

-- 統計用インデックス
CREATE INDEX idx_page_views_article ON page_views(article_id);
CREATE INDEX idx_page_views_date ON page_views(viewed_at);
CREATE INDEX idx_affiliate_clicks_article ON affiliate_clicks(article_id);
```

---

## 法的コンプライアンス

### 年齢確認システム

#### 実装方針

日本の法的要件に基づき、18歳未満の閲覧を制限するシステムを実装。

#### 技術実装

```typescript
// /app/age-verification/page.tsx
'use client'
import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import Cookies from 'js-cookie'

const AgeVerification = () => {
  const router = useRouter()
  const [isVerified, setIsVerified] = useState(false)

  useEffect(() => {
    const verified = Cookies.get('age_verified')
    if (verified === 'true') {
      router.push('/')
    }
  }, [router])

  const handleAgeConfirm = () => {
    // 30日間のCookie設定
    Cookies.set('age_verified', 'true', { expires: 30 })
    setIsVerified(true)
    router.push('/')
  }

  const handleAgeDeny = () => {
    // 外部サイトへリダイレクト
    window.location.href = 'https://www.google.com'
  }

  return (
    <div className="min-h-screen bg-gray-900 flex items-center justify-center">
      <div className="bg-white rounded-lg p-8 max-w-md w-full mx-4">
        <h1 className="text-2xl font-bold text-center mb-6">年齢確認</h1>

        <div className="text-center mb-6">
          <p className="text-gray-700 mb-4">
            このサイトはアダルトコンテンツを含みます。
          </p>
          <p className="text-lg font-bold text-red-600">
            あなたは18歳以上ですか？
          </p>
        </div>

        <div className="flex flex-col space-y-4">
          <button
            onClick={handleAgeConfirm}
            className="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors"
          >
            はい（18歳以上）
          </button>
          <button
            onClick={handleAgeDeny}
            className="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors"
          >
            いいえ（18歳未満）
          </button>
        </div>

        <div className="mt-6 text-xs text-gray-500 text-center">
          <p>
            このサイトに入ることで、あなたが18歳以上であることを確認し、
            <a href="/terms" className="text-blue-600 hover:underline">利用規約</a>
            に同意したものとみなされます。
          </p>
        </div>
      </div>
    </div>
  )
}

export default AgeVerification
```

#### ミドルウェアによる保護

```typescript
// /middleware.ts
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  const ageVerified = request.cookies.get('age_verified')
  const { pathname } = request.nextUrl

  // 年齢確認が必要なページ
  const protectedPaths = ['/fuzoku', '/fanza', '/']
  const isProtectedPath = protectedPaths.some(path => pathname.startsWith(path))

  // 年齢確認ページ以外で年齢確認が必要な場合
  if (isProtectedPath && pathname !== '/age-verification' && !ageVerified) {
    return NextResponse.redirect(new URL('/age-verification', request.url))
  }

  return NextResponse.next()
}

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
}
```

### 利用規約・プライバシーポリシー

#### 利用規約テンプレート

```markdown
# 利用規約

## 第1条（適用）

本規約は、高山まさあきの夜遊び研究所（以下「当サイト」）が提供するサービスの利用条件を定めるものです。

## 第2条（年齢制限）

1. 本サービスは18歳未満の方のご利用をお断りしています。
2. 利用者は18歳以上であることを保証するものとします。

## 第3条（コンテンツの取り扱い）

1. 当サイトのコンテンツは成人向けの内容を含みます。
2. コンテンツの無断転載・複製を禁止します。
3. 営利目的での利用を禁止します。

## 第4条（免責事項）

1. 当サイトは情報の正確性を保証しません。
2. 利用者の判断と責任において情報をご利用ください。
3. 当サイトの利用による損害について一切の責任を負いません。

## 第5条（アフィリエイトについて）

1. 当サイトは収益化のためアフィリエイトプログラムを利用しています。
2. アフィリエイトリンクには適切な表示を行います。

## 第6条（プライバシー）

個人情報の取り扱いについては、別途定めるプライバシーポリシーに従います。
```

#### プライバシーポリシー

```markdown
# プライバシーポリシー

## 収集する情報

### 自動的に収集される情報

- IPアドレス
- ブラウザ情報
- アクセス日時
- 閲覧ページ
- リファラー情報

### Cookieの利用

- 年齢確認状態の保存
- アクセス解析
- 広告配信の最適化

## 情報の利用目的

- サイトの改善・最適化
- アクセス解析・統計作成
- 不正利用の防止
- 法令遵守

## 第三者への提供

### アクセス解析ツール

- Google Analytics
- Google Search Console

### アフィリエイトサービス

- FANZA アフィリエイト
- A8.net
- その他アフィリエイトサービス

## お問い合わせ

プライバシーに関するお問い合わせは、お問い合わせフォームよりご連絡ください。
```

---

## コンテンツ管理システム

### MDX + Supabase ハイブリッドCMS

#### 設計思想

- **MDX**: 記事本文の豊富な表現力
- **Supabase**: メタデータ・統計情報の管理
- **Git**: バージョン管理・バックアップ

#### MDX記事構造

```mdx
---
title: '横浜デリヘル「○○○」研究報告書'
slug: 'yokohama-delivery-research-001'
category: 'fuzoku'
subcategory: 'delivery'
tags: ['横浜', 'デリヘル', '体験談']
publishedAt: '2025-07-15'
updatedAt: '2025-07-15'
metaTitle: '横浜デリヘル「○○○」実体験レポート｜料金・サービス・評価を詳細解説'
metaDescription: '横浜の人気デリヘル店「○○○」を実際に利用した詳細レポート。料金、サービス内容、女性の質を研究員が客観的に分析します。'
ogImage: '/images/fuzoku/yokohama-delivery-001.jpg'
rating: 4.2
researchMethod: '参与観察法'
researchPeriod: '2025年7月'
researchBudget: 25000
establishmentId: 'uuid-of-establishment'
---

# 横浜デリヘル「○○○」研究報告書

## 研究概要

この研究は、横浜エリアで営業するデリヘル店「○○○」について、
実際の利用体験を通じて客観的な分析を行ったものです。

### 研究目的

- サービス内容の詳細分析
- 料金体系の妥当性検証
- 顧客満足度の測定

## 研究方法

**調査方法**: 参与観察法
**調査期間**: 2025年7月
**調査予算**: 25,000円
**調査回数**: 1回

## 基本情報

<EstablishmentInfo id="uuid-of-establishment" />

## 研究結果

### 1. 予約・アクセス

予約は電話で行い、対応は丁寧で好印象でした。
最寄り駅からの待ち合わせもスムーズで、
初回利用者への配慮が感じられました。

### 2. サービス内容

<ServiceAnalysis>
  - 基本サービス: ★★★★☆ - 追加オプション: ★★★☆☆ - 時間配分: ★★★★★ - 満足度:
  ★★★★☆
</ServiceAnalysis>

### 3. コストパフォーマンス分析

<CostAnalysis>
  | 項目 | 料金 | 評価 | |------|------|------| | 基本料金 | 15,000円 | ★★★☆☆ |
  | 交通費 | 2,000円 | ★★★★☆ | | オプション | 8,000円 | ★★☆☆☆ | | 合計 |
  25,000円 | ★★★☆☆ |
</CostAnalysis>

## 研究結論

総合評価: ★★★★☆ (4.2/5)

### 推奨ポイント

1. スタッフの対応が丁寧
2. 時間配分が適切
3. 清潔感のある環境

### 改善点

1. オプション料金の妥当性
2. 女性の技術的スキル
3. アフターサービス

## 今後の研究課題

- 他店舗との比較分析
- 長期利用による変化の観察
- 季節変動の影響調査

---

_研究報告書番号: YDR-001_
_研究責任者: 高山まさあき_
_研究所: 夜遊び研究所_
```

#### カスタムMDXコンポーネント

```typescript
// /components/mdx/EstablishmentInfo.tsx
interface EstablishmentInfoProps {
  id: string
}

const EstablishmentInfo: React.FC<EstablishmentInfoProps> = ({ id }) => {
  const [establishment, setEstablishment] = useState(null)

  useEffect(() => {
    // Supabaseから店舗情報を取得
    const fetchEstablishment = async () => {
      const { data } = await supabase
        .from('establishments')
        .select('*')
        .eq('id', id)
        .single()
      setEstablishment(data)
    }
    fetchEstablishment()
  }, [id])

  if (!establishment) return <div>読み込み中...</div>

  return (
    <div className="bg-gray-50 p-6 rounded-lg my-6">
      <h3 className="text-xl font-bold mb-4">店舗基本情報</h3>
      <div className="grid grid-cols-2 gap-4">
        <div>
          <p><strong>店舗名:</strong> {establishment.name}</p>
          <p><strong>業種:</strong> {establishment.type}</p>
          <p><strong>エリア:</strong> {establishment.area}</p>
        </div>
        <div>
          <p><strong>料金帯:</strong> {establishment.price_range}</p>
          <p><strong>評価:</strong> ★★★★☆ ({establishment.rating})</p>
          <p><strong>研究回数:</strong> {establishment.visit_count}回</p>
        </div>
      </div>
    </div>
  )
}

export default EstablishmentInfo
```

### 管理画面システム

#### 記事管理インターフェース

```typescript
// /app/admin/articles/page.tsx
const ArticlesAdmin = () => {
  const [articles, setArticles] = useState([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    const fetchArticles = async () => {
      const { data, error } = await supabase
        .from('articles')
        .select(`
          *,
          categories(name, slug),
          establishments(name),
          fanza_works(title)
        `)
        .order('created_at', { ascending: false })

      if (error) {
        console.error('Error fetching articles:', error)
      } else {
        setArticles(data)
      }
      setLoading(false)
    }

    fetchArticles()
  }, [])

  return (
    <div className="container mx-auto px-4 py-8">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold">記事管理</h1>
        <Link href="/admin/articles/new" className="bg-blue-600 text-white px-4 py-2 rounded">
          新規記事作成
        </Link>
      </div>

      {loading ? (
        <div>読み込み中...</div>
      ) : (
        <div className="bg-white rounded-lg shadow overflow-hidden">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  タイトル
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  カテゴリ
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  ステータス
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  公開日
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  PV数
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  操作
                </th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {articles.map((article) => (
                <tr key={article.id} className="hover:bg-gray-50">
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="text-sm font-medium text-gray-900">
                      {article.title}
                    </div>
                    <div className="text-sm text-gray-500">
                      /{article.slug}
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                      {article.categories?.name}
                    </span>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                      article.status === 'published'
                        ? 'bg-green-100 text-green-800'
                        : 'bg-yellow-100 text-yellow-800'
                    }`}>
                      {article.status === 'published' ? '公開中' : '下書き'}
                    </span>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {article.published_at ? new Date(article.published_at).toLocaleDateString() : '-'}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {article.view_count.toLocaleString()}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <Link href={`/admin/articles/${article.id}`} className="text-blue-600 hover:text-blue-900 mr-4">
                      編集
                    </Link>
                    <Link href={`/${article.article_type}/${article.slug}`} className="text-green-600 hover:text-green-900">
                      表示
                    </Link>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  )
}

export default ArticlesAdmin
```

---

## アフィリエイト連携システム

### FANZA API連携

#### API設定

```typescript
// /lib/fanza/api.ts
interface FanzaApiConfig {
  apiId: string
  affiliateId: string
  baseUrl: string
}

interface FanzaItem {
  content_id: string
  title: string
  actress: string
  director: string
  genre: string
  date: string
  price: number
  imageURL: {
    small: string
    large: string
  }
  affiliateURL: string
}

class FanzaApi {
  private config: FanzaApiConfig

  constructor() {
    this.config = {
      apiId: process.env.FANZA_API_ID!,
      affiliateId: process.env.FANZA_AFFILIATE_ID!,
      baseUrl: 'https://api.dmm.com/affiliate/v3',
    }
  }

  async searchItems(params: {
    keyword?: string
    actress?: string
    genre?: string
    sort?: 'date' | 'price' | 'review'
    hits?: number
    offset?: number
  }): Promise<FanzaItem[]> {
    const queryParams = new URLSearchParams({
      api_id: this.config.apiId,
      affiliate_id: this.config.affiliateId,
      site: 'FANZA',
      service: 'digital',
      floor: 'videoa',
      output: 'json',
      ...params,
    })

    const response = await fetch(
      `${this.config.baseUrl}/ItemList?${queryParams}`
    )
    const data = await response.json()

    return data.result.items || []
  }

  async getItemDetails(contentId: string): Promise<FanzaItem | null> {
    const params = new URLSearchParams({
      api_id: this.config.apiId,
      affiliate_id: this.config.affiliateId,
      site: 'FANZA',
      service: 'digital',
      floor: 'videoa',
      output: 'json',
      cid: contentId,
    })

    const response = await fetch(`${this.config.baseUrl}/ItemList?${params}`)
    const data = await response.json()

    return data.result.items?.[0] || null
  }

  generateAffiliateLink(contentId: string): string {
    return `https://al.dmm.co.jp/?lurl=https%3A%2F%2Fwww.dmm.co.jp%2Fdigital%2Fvideoa%2F-%2Fdetail%2F%3D%2Fcid%3D${contentId}%2F&af_id=${this.config.affiliateId}&ch=api`
  }
}

export const fanzaApi = new FanzaApi()
```

#### 自動データ更新システム

```typescript
// /lib/cron/fanza-sync.ts
import { fanzaApi } from '@/lib/fanza/api'
import { supabase } from '@/lib/supabase/server'

export async function syncFanzaData() {
  try {
    // 新作動画の取得
    const newItems = await fanzaApi.searchItems({
      sort: 'date',
      hits: 50,
    })

    for (const item of newItems) {
      // 既存データの確認
      const { data: existingItem } = await supabase
        .from('fanza_works')
        .select('id')
        .eq('fanza_id', item.content_id)
        .single()

      if (!existingItem) {
        // 新規データの挿入
        await supabase.from('fanza_works').insert({
          fanza_id: item.content_id,
          title: item.title,
          actress_name: item.actress,
          director: item.director,
          genre: item.genre,
          release_date: item.date,
          fanza_url: item.affiliateURL,
          thumbnail_url: item.imageURL.large,
          price: item.price,
          last_checked_at: new Date().toISOString(),
        })
      } else {
        // 既存データの更新
        await supabase
          .from('fanza_works')
          .update({
            title: item.title,
            actress_name: item.actress,
            director: item.director,
            genre: item.genre,
            price: item.price,
            last_checked_at: new Date().toISOString(),
          })
          .eq('fanza_id', item.content_id)
      }
    }

    console.log(`FANZA data sync completed: ${newItems.length} items processed`)
  } catch (error) {
    console.error('FANZA sync error:', error)
  }
}
```

#### アフィリエイトリンク生成コンポーネント

```typescript
// /components/affiliate/FanzaLink.tsx
interface FanzaLinkProps {
  contentId: string
  title: string
  imageUrl?: string
  price?: number
  className?: string
}

const FanzaLink: React.FC<FanzaLinkProps> = ({
  contentId,
  title,
  imageUrl,
  price,
  className = ""
}) => {
  const handleClick = async () => {
    // アフィリエイトクリック統計の記録
    await fetch('/api/affiliate/click', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        affiliate_type: 'fanza',
        affiliate_id: contentId,
        article_id: window.location.pathname
      })
    })
  }

  const affiliateUrl = `https://al.dmm.co.jp/?lurl=https%3A%2F%2Fwww.dmm.co.jp%2Fdigital%2Fvideoa%2F-%2Fdetail%2F%3D%2Fcid%3D${contentId}%2F&af_id=${process.env.NEXT_PUBLIC_FANZA_AFFILIATE_ID}&ch=api`

  return (
    <div className={`bg-white rounded-lg shadow-md overflow-hidden ${className}`}>
      <a
        href={affiliateUrl}
        target="_blank"
        rel="noopener noreferrer"
        onClick={handleClick}
        className="block hover:shadow-lg transition-shadow"
      >
        {imageUrl && (
          <div className="aspect-w-16 aspect-h-9">
            <img
              src={imageUrl}
              alt={title}
              className="w-full h-full object-cover"
            />
          </div>
        )}
        <div className="p-4">
          <h3 className="font-bold text-lg mb-2 line-clamp-2">{title}</h3>
          {price && (
            <p className="text-red-600 font-bold">
              ¥{price.toLocaleString()}
            </p>
          )}
          <div className="mt-4 flex items-center justify-between">
            <span className="text-sm text-gray-500">FANZA</span>
            <span className="bg-blue-600 text-white px-4 py-2 rounded-full text-sm font-medium">
              詳細を見る
            </span>
          </div>
        </div>
      </a>
      <div className="px-4 pb-4">
        <p className="text-xs text-gray-400">
          ※このリンクは研究所の運営をサポートするアフィリエイトリンクです
        </p>
      </div>
    </div>
  )
}

export default FanzaLink
```

### 収益最適化システム

#### A/Bテスト機能

```typescript
// /lib/ab-test/manager.ts
interface ABTestConfig {
  testId: string
  variants: {
    id: string
    name: string
    weight: number
  }[]
  startDate: Date
  endDate: Date
  isActive: boolean
}

class ABTestManager {
  private tests: ABTestConfig[] = [
    {
      testId: 'cta-button-color',
      variants: [
        { id: 'blue', name: 'Blue CTA', weight: 50 },
        { id: 'red', name: 'Red CTA', weight: 50 },
      ],
      startDate: new Date('2025-07-01'),
      endDate: new Date('2025-07-31'),
      isActive: true,
    },
  ]

  getVariant(testId: string, userId: string): string {
    const test = this.tests.find(t => t.testId === testId && t.isActive)
    if (!test) return 'default'

    // ユーザーIDに基づいた一貫性のある分岐
    const hash = this.hashString(userId + testId)
    const random = hash % 100

    let cumulative = 0
    for (const variant of test.variants) {
      cumulative += variant.weight
      if (random < cumulative) {
        return variant.id
      }
    }

    return test.variants[0].id
  }

  private hashString(str: string): number {
    let hash = 0
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i)
      hash = (hash << 5) - hash + char
      hash = hash & hash // Convert to 32-bit integer
    }
    return Math.abs(hash)
  }
}

export const abTestManager = new ABTestManager()
```

---

## SEO・アクセシビリティ

### SEO最適化設定

#### メタデータ管理

```typescript
// /lib/seo/metadata.ts
import { Metadata } from 'next'

interface SEOData {
  title: string
  description: string
  keywords?: string[]
  ogImage?: string
  canonical?: string
  noindex?: boolean
}

export function generateMetadata(data: SEOData): Metadata {
  const siteName = '高山まさあきの夜遊び研究所'
  const baseUrl = 'https://takayamalog.com'

  return {
    title: `${data.title} | ${siteName}`,
    description: data.description,
    keywords: data.keywords?.join(', '),
    robots: {
      index: !data.noindex,
      follow: true,
      googleBot: {
        index: !data.noindex,
        follow: true,
        'max-video-preview': -1,
        'max-image-preview': 'large',
        'max-snippet': -1,
      },
    },
    openGraph: {
      title: data.title,
      description: data.description,
      url: data.canonical || baseUrl,
      siteName: siteName,
      images: [
        {
          url: data.ogImage || `${baseUrl}/images/og-default.jpg`,
          width: 1200,
          height: 630,
          alt: data.title,
        },
      ],
      locale: 'ja_JP',
      type: 'article',
    },
    twitter: {
      card: 'summary_large_image',
      title: data.title,
      description: data.description,
      creator: '@takayama_masaaki',
      images: [data.ogImage || `${baseUrl}/images/og-default.jpg`],
    },
    alternates: {
      canonical: data.canonical || baseUrl,
    },
  }
}
```

#### 構造化データ

```typescript
// /lib/seo/structured-data.ts
interface ArticleStructuredData {
  headline: string
  description: string
  image: string
  author: {
    name: string
    url: string
  }
  publisher: {
    name: string
    logo: string
  }
  datePublished: string
  dateModified: string
  url: string
}

export function generateArticleStructuredData(data: ArticleStructuredData) {
  return {
    '@context': 'https://schema.org',
    '@type': 'Article',
    headline: data.headline,
    description: data.description,
    image: data.image,
    author: {
      '@type': 'Person',
      name: data.author.name,
      url: data.author.url,
    },
    publisher: {
      '@type': 'Organization',
      name: data.publisher.name,
      logo: {
        '@type': 'ImageObject',
        url: data.publisher.logo,
      },
    },
    datePublished: data.datePublished,
    dateModified: data.dateModified,
    url: data.url,
  }
}

export function generateWebsiteStructuredData() {
  return {
    '@context': 'https://schema.org',
    '@type': 'WebSite',
    name: '高山まさあきの夜遊び研究所',
    url: 'https://takayamalog.com',
    description:
      '風俗ライター・高山まさあきが運営する、大人の夜遊びを研究する読み物サイト',
    author: {
      '@type': 'Person',
      name: '高山まさあき',
      description: '風俗ライター・夜遊び研究所所長',
    },
    potentialAction: {
      '@type': 'SearchAction',
      target: 'https://takayamalog.com/search?q={search_term_string}',
      'query-input': 'required name=search_term_string',
    },
  }
}
```

### アクセシビリティ対応

#### WCAG 2.2 レベルAA準拠

```typescript
// /components/ui/AccessibleButton.tsx
interface AccessibleButtonProps {
  children: React.ReactNode
  onClick?: () => void
  disabled?: boolean
  variant?: 'primary' | 'secondary' | 'danger'
  size?: 'sm' | 'md' | 'lg'
  ariaLabel?: string
  ariaDescribedBy?: string
}

const AccessibleButton: React.FC<AccessibleButtonProps> = ({
  children,
  onClick,
  disabled = false,
  variant = 'primary',
  size = 'md',
  ariaLabel,
  ariaDescribedBy,
}) => {
  const baseClasses = 'inline-flex items-center justify-center font-medium rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2'

  const variantClasses = {
    primary: 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500 disabled:bg-gray-400',
    secondary: 'bg-gray-600 text-white hover:bg-gray-700 focus:ring-gray-500 disabled:bg-gray-400',
    danger: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500 disabled:bg-gray-400'
  }

  const sizeClasses = {
    sm: 'px-3 py-2 text-sm',
    md: 'px-4 py-2 text-base',
    lg: 'px-6 py-3 text-lg'
  }

  return (
    <button
      className={`${baseClasses} ${variantClasses[variant]} ${sizeClasses[size]}`}
      onClick={onClick}
      disabled={disabled}
      aria-label={ariaLabel}
      aria-describedby={ariaDescribedBy}
      type="button"
    >
      {children}
    </button>
  )
}

export default AccessibleButton
```

#### キーボードナビゲーション

```typescript
// /hooks/useKeyboardNavigation.ts
import { useEffect, useRef } from 'react'

export function useKeyboardNavigation(items: HTMLElement[]) {
  const currentIndex = useRef(0)

  useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      switch (event.key) {
        case 'ArrowUp':
          event.preventDefault()
          currentIndex.current = Math.max(0, currentIndex.current - 1)
          items[currentIndex.current]?.focus()
          break
        case 'ArrowDown':
          event.preventDefault()
          currentIndex.current = Math.min(
            items.length - 1,
            currentIndex.current + 1
          )
          items[currentIndex.current]?.focus()
          break
        case 'Home':
          event.preventDefault()
          currentIndex.current = 0
          items[0]?.focus()
          break
        case 'End':
          event.preventDefault()
          currentIndex.current = items.length - 1
          items[items.length - 1]?.focus()
          break
        case 'Enter':
        case ' ':
          event.preventDefault()
          items[currentIndex.current]?.click()
          break
      }
    }

    document.addEventListener('keydown', handleKeyDown)
    return () => document.removeEventListener('keydown', handleKeyDown)
  }, [items])

  return currentIndex.current
}
```

---

## セキュリティ・パフォーマンス

### セキュリティ対策

#### Next.js 14 最新セキュリティ対応

```typescript
// /middleware.ts (セキュリティ強化版)
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  const response = NextResponse.next()

  // セキュリティヘッダー設定
  response.headers.set('X-Content-Type-Options', 'nosniff')
  response.headers.set('X-Frame-Options', 'DENY')
  response.headers.set('X-XSS-Protection', '1; mode=block')
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin')
  response.headers.set(
    'Permissions-Policy',
    'camera=(), microphone=(), geolocation=()'
  )

  // CSPヘッダー設定
  const cspHeader = `
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com;
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https:;
    font-src 'self';
    connect-src 'self' https://api.dmm.com https://*.supabase.co;
    frame-ancestors 'none';
  `
    .replace(/\s{2,}/g, ' ')
    .trim()

  response.headers.set('Content-Security-Policy', cspHeader)

  // 年齢確認チェック
  const ageVerified = request.cookies.get('age_verified')?.value
  const pathname = request.nextUrl.pathname

  // 管理者画面のアクセス制御
  if (pathname.startsWith('/admin')) {
    const authToken = request.cookies.get('auth_token')?.value
    if (!authToken) {
      return NextResponse.redirect(new URL('/login', request.url))
    }
  }

  // Rate limiting (簡易版)
  const ip = request.ip || request.headers.get('x-forwarded-for') || 'unknown'
  const rateLimitKey = `rate_limit_${ip}`

  // 実装時はRedisなどの外部ストレージを使用
  // ここでは概念的な実装例

  return response
}

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
}
```

#### 入力値検証

```typescript
// /lib/validation/schemas.ts
import { z } from 'zod'

export const articleSchema = z.object({
  title: z
    .string()
    .min(1, '記事タイトルは必須です')
    .max(255, '記事タイトルは255文字以内で入力してください'),
  slug: z
    .string()
    .min(1, 'スラッグは必須です')
    .regex(
      /^[a-z0-9-]+$/,
      'スラッグは英小文字、数字、ハイフンのみ使用可能です'
    ),
  content: z.string().min(1, '記事内容は必須です'),
  excerpt: z
    .string()
    .max(500, '要約は500文字以内で入力してください')
    .optional(),
  categoryId: z.string().uuid('有効なカテゴリIDを選択してください'),
  tags: z.array(z.string()).max(10, 'タグは10個まで設定可能です').optional(),
  metaTitle: z
    .string()
    .max(60, 'メタタイトルは60文字以内で入力してください')
    .optional(),
  metaDescription: z
    .string()
    .max(160, 'メタディスクリプションは160文字以内で入力してください')
    .optional(),
  rating: z.number().min(0).max(5).optional(),
})

export const contactSchema = z.object({
  name: z
    .string()
    .min(1, '名前は必須です')
    .max(100, '名前は100文字以内で入力してください'),
  email: z.string().email('有効なメールアドレスを入力してください'),
  subject: z
    .string()
    .min(1, '件名は必須です')
    .max(200, '件名は200文字以内で入力してください'),
  message: z
    .string()
    .min(1, 'メッセージは必須です')
    .max(2000, 'メッセージは2000文字以内で入力してください'),
})
```

### パフォーマンス最適化

#### 画像最適化

```typescript
// /components/ui/OptimizedImage.tsx
import Image from 'next/image'
import { useState } from 'react'

interface OptimizedImageProps {
  src: string
  alt: string
  width: number
  height: number
  priority?: boolean
  className?: string
  sizes?: string
}

const OptimizedImage: React.FC<OptimizedImageProps> = ({
  src,
  alt,
  width,
  height,
  priority = false,
  className = '',
  sizes = '(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw'
}) => {
  const [isLoading, setIsLoading] = useState(true)
  const [hasError, setHasError] = useState(false)

  const handleLoad = () => {
    setIsLoading(false)
  }

  const handleError = () => {
    setIsLoading(false)
    setHasError(true)
  }

  if (hasError) {
    return (
      <div className={`flex items-center justify-center bg-gray-200 ${className}`}>
        <span className="text-gray-500">画像を読み込めませんでした</span>
      </div>
    )
  }

  return (
    <div className={`relative overflow-hidden ${className}`}>
      {isLoading && (
        <div className="absolute inset-0 bg-gray-200 animate-pulse" />
      )}
      <Image
        src={src}
        alt={alt}
        width={width}
        height={height}
        priority={priority}
        sizes={sizes}
        onLoad={handleLoad}
        onError={handleError}
        className={`transition-opacity duration-300 ${isLoading ? 'opacity-0' : 'opacity-100'}`}
        placeholder="blur"
        blurDataURL="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCdABmX/9k="
      />
    </div>
  )
}

export default OptimizedImage
```

#### キャッシュ戦略

```typescript
// /lib/cache/manager.ts
interface CacheItem<T> {
  data: T
  timestamp: number
  ttl: number
}

class CacheManager {
  private cache = new Map<string, CacheItem<any>>()
  private memoryLimit = 100 // Maximum number of items in memory

  set<T>(key: string, data: T, ttl: number = 3600000): void {
    // メモリ制限チェック
    if (this.cache.size >= this.memoryLimit) {
      this.evictOldest()
    }

    this.cache.set(key, {
      data,
      timestamp: Date.now(),
      ttl,
    })
  }

  get<T>(key: string): T | null {
    const item = this.cache.get(key)

    if (!item) return null

    // TTLチェック
    if (Date.now() - item.timestamp > item.ttl) {
      this.cache.delete(key)
      return null
    }

    return item.data
  }

  has(key: string): boolean {
    return this.get(key) !== null
  }

  delete(key: string): void {
    this.cache.delete(key)
  }

  clear(): void {
    this.cache.clear()
  }

  private evictOldest(): void {
    let oldestKey = ''
    let oldestTime = Date.now()

    for (const [key, item] of this.cache) {
      if (item.timestamp < oldestTime) {
        oldestTime = item.timestamp
        oldestKey = key
      }
    }

    if (oldestKey) {
      this.cache.delete(oldestKey)
    }
  }
}

export const cacheManager = new CacheManager()
```

---

## デプロイメント・インフラ

### Vercel設定

#### プロジェクト設定

```json
{
  "name": "takayamalog",
  "version": "1.0.0",
  "framework": "nextjs",
  "buildCommand": "npm run build",
  "devCommand": "npm run dev",
  "installCommand": "npm install",
  "outputDirectory": ".next",
  "public": true,
  "env": {
    "NEXT_PUBLIC_SUPABASE_URL": "@supabase-url",
    "NEXT_PUBLIC_SUPABASE_ANON_KEY": "@supabase-anon-key",
    "SUPABASE_SERVICE_ROLE_KEY": "@supabase-service-role-key",
    "NEXT_PUBLIC_GA_ID": "@ga-id",
    "FANZA_API_ID": "@fanza-api-id",
    "FANZA_AFFILIATE_ID": "@fanza-affiliate-id"
  },
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "X-Content-Type-Options",
          "value": "nosniff"
        },
        {
          "key": "X-Frame-Options",
          "value": "DENY"
        },
        {
          "key": "X-XSS-Protection",
          "value": "1; mode=block"
        }
      ]
    }
  ],
  "redirects": [
    {
      "source": "/admin",
      "destination": "/admin/dashboard",
      "permanent": true
    }
  ],
  "rewrites": [
    {
      "source": "/sitemap.xml",
      "destination": "/api/sitemap"
    }
  ]
}
```

### NamecheapドメインとVercel連携

#### DNS設定手順

1. **Namecheap管理画面**でドメイン設定
2. **Custom DNS**を選択
3. **Vercel提供のネームサーバー**を設定
   - `ns1.vercel-dns.com`
   - `ns2.vercel-dns.com`

#### Vercel側設定

```bash
# Vercel CLIを使用したドメイン設定
vercel domains add takayamalog.com
vercel domains add www.takayamalog.com

# SSL証明書の自動設定確認
vercel certs ls
```

### 継続的デプロイメント

#### GitHub Actions設定

```yaml
# .github/workflows/deploy.yml
name: Deploy to Vercel

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run type check
        run: npm run type-check

      - name: Run linting
        run: npm run lint

      - name: Run tests
        run: npm run test:ci

      - name: Build project
        run: npm run build

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          working-directory: ./
          scope: masa162
```

---

## 運用・保守計画

### 日常運用タスク

#### 毎日のチェック項目

```typescript
// /scripts/daily-check.ts
import { supabase } from '@/lib/supabase/server'
import { fanzaApi } from '@/lib/fanza/api'

export async function dailyHealthCheck() {
  const checks = {
    database: false,
    fanzaApi: false,
    sitemap: false,
    images: false,
  }

  try {
    // データベース接続確認
    const { data: dbCheck } = await supabase
      .from('articles')
      .select('count')
      .limit(1)
    checks.database = !!dbCheck

    // FANZA API接続確認
    const fanzaCheck = await fanzaApi.searchItems({ hits: 1 })
    checks.fanzaApi = fanzaCheck.length > 0

    // サイトマップ確認
    const sitemapResponse = await fetch('https://takayamalog.com/sitemap.xml')
    checks.sitemap = sitemapResponse.ok

    // 画像リンク確認（サンプル）
    const imageResponse = await fetch(
      'https://takayamalog.com/images/og-default.jpg'
    )
    checks.images = imageResponse.ok

    console.log('Daily health check results:', checks)

    // 問題がある場合はアラート送信
    const hasIssues = Object.values(checks).some(check => !check)
    if (hasIssues) {
      await sendAlert('Daily health check failed', checks)
    }
  } catch (error) {
    console.error('Daily health check error:', error)
    await sendAlert('Daily health check error', error)
  }
}

async function sendAlert(message: string, details: any) {
  // Slack、メール、Discord等への通知実装
  console.log('ALERT:', message, details)
}
```

### 定期メンテナンス

#### 週次メンテナンス

```typescript
// /scripts/weekly-maintenance.ts
export async function weeklyMaintenance() {
  console.log('Starting weekly maintenance...')

  try {
    // 1. データベース最適化
    await optimizeDatabase()

    // 2. 古いログの削除
    await cleanupOldLogs()

    // 3. 画像最適化
    await optimizeImages()

    // 4. キャッシュクリア
    await clearStaleCache()

    // 5. アナリティクスレポート生成
    await generateWeeklyReport()

    console.log('Weekly maintenance completed successfully')
  } catch (error) {
    console.error('Weekly maintenance failed:', error)
    await sendAlert('Weekly maintenance failed', error)
  }
}

async function optimizeDatabase() {
  // 古いページビューデータの削除（90日以上）
  const ninetyDaysAgo = new Date(Date.now() - 90 * 24 * 60 * 60 * 1000)

  await supabase
    .from('page_views')
    .delete()
    .lt('viewed_at', ninetyDaysAgo.toISOString())

  // インデックスの最適化
  await supabase.rpc('optimize_indexes')
}

async function cleanupOldLogs() {
  // アプリケーションログの削除
  // 実装は使用するログサービスに依存
}

async function optimizeImages() {
  // 未使用画像の検出と削除
  // 画像圧縮の実行
}

async function clearStaleCache() {
  // キャッシュの無効化
  cacheManager.clear()
}

async function generateWeeklyReport() {
  // 週次レポートの生成
  const report = await generateAnalyticsReport('week')
  console.log('Weekly report generated:', report)
}
```

### バックアップ戦略

#### データベースバックアップ

```sql
-- Supabase自動バックアップ設定
-- 毎日午前2時にバックアップ実行
-- 7日間のバックアップを保持
-- Point-in-Time Recovery有効

-- 手動バックアップ用SQL
CREATE OR REPLACE FUNCTION backup_critical_tables()
RETURNS void AS $$
BEGIN
  -- 記事データのバックアップ
  CREATE TABLE IF NOT EXISTS backup_articles AS SELECT * FROM articles WHERE FALSE;
  TRUNCATE backup_articles;
  INSERT INTO backup_articles SELECT * FROM articles;

  -- カテゴリデータのバックアップ
  CREATE TABLE IF NOT EXISTS backup_categories AS SELECT * FROM categories WHERE FALSE;
  TRUNCATE backup_categories;
  INSERT INTO backup_categories SELECT * FROM categories;

  -- 店舗データのバックアップ
  CREATE TABLE IF NOT EXISTS backup_establishments AS SELECT * FROM establishments WHERE FALSE;
  TRUNCATE backup_establishments;
  INSERT INTO backup_establishments SELECT * FROM establishments;

  RAISE NOTICE 'Backup completed at %', NOW();
END;
$$ LANGUAGE plpgsql;
```

### 監視・アラート設定

#### Vercel Analytics統合

```typescript
// /lib/monitoring/vercel.ts
import { Analytics } from '@vercel/analytics/react'
import { SpeedInsights } from '@vercel/speed-insights/next'

export function VercelMonitoring() {
  return (
    <>
      <Analytics />
      <SpeedInsights />
    </>
  )
}

// カスタムメトリクス送信
export function trackCustomMetric(name: string, value: number, tags?: Record<string, string>) {
  if (typeof window !== 'undefined') {
    (window as any).va?.track(name, { value, ...tags })
  }
}
```

---

## 開発ロードマップ

### Phase 1: 基盤構築（Month 1-2）

#### Week 1-2: 環境構築

- [x] GitHub リポジトリ設定
- [x] Vercel プロジェクト作成
- [x] Namecheap ドメイン設定
- [ ] Next.js 14 プロジェクト初期化
- [ ] Supabase プロジェクト設定
- [ ] 基本的なCI/CD設定

#### Week 3-4: 基本機能実装

- [ ] 年齢確認システム実装
- [ ] 基本レイアウト構築
- [ ] 記事表示機能
- [ ] 管理画面基本機能
- [ ] データベース設計・実装

#### Week 5-6: コンテンツ機能

- [ ] MDX統合
- [ ] 画像アップロード機能
- [ ] カテゴリ管理機能
- [ ] 検索機能実装

#### Week 7-8: 品質向上

- [ ] SEO最適化
- [ ] アクセシビリティ対応
- [ ] パフォーマンス最適化
- [ ] テスト実装

### Phase 2: コンテンツ拡充（Month 3-4）

#### Week 9-10: FANZA連携

- [ ] FANZA API統合
- [ ] 動画情報自動取得
- [ ] アフィリエイトリンク生成
- [ ] レビュー機能実装

#### Week 11-12: 風俗情報機能

- [ ] 店舗情報管理
- [ ] 体験談テンプレート
- [ ] 地域別検索機能
- [ ] 評価システム実装

#### Week 13-14: 高度な機能

- [ ] 統計・分析機能
- [ ] A/Bテスト実装
- [ ] 個人化機能
- [ ] 通知システム

#### Week 15-16: 最適化

- [ ] コンバージョン最適化
- [ ] ユーザー体験向上
- [ ] モバイル最適化
- [ ] 表示速度改善

### Phase 3: 運用・拡張（Month 5-6）

#### Week 17-18: 分析・改善

- [ ] アクセス解析詳細化
- [ ] ユーザー行動分析
- [ ] コンテンツ効果測定
- [ ] 収益分析システム

#### Week 19-20: 自動化

- [ ] コンテンツ自動投稿
- [ ] SNS自動連携
- [ ] バックアップ自動化
- [ ] 監視システム強化

#### Week 21-22: 拡張機能

- [ ] 会員システム
- [ ] コメント機能
- [ ] ブックマーク機能
- [ ] 推薦システム

#### Week 23-24: 最終調整

- [ ] 全体最適化
- [ ] セキュリティ強化
- [ ] ドキュメント整備
- [ ] 本格運用開始

---

## 実装ガイドライン

### 開発環境セットアップ

#### 必要なツール

```bash
# Node.js 18以上
node --version

# npm または yarn
npm --version

# Git
git --version

# Vercel CLI
npm i -g vercel

# Supabase CLI
npm i -g supabase
```

#### プロジェクト初期化

```bash
# リポジトリクローン
git clone https://github.com/masa162/takayamalog.git
cd takayamalog

# 依存関係インストール
npm install

# 環境変数設定
cp .env.example .env.local
# .env.localを編集

# 開発サーバー起動
npm run dev
```

### コーディング規約

#### TypeScript設定

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "lib": ["dom", "dom.iterable", "ES2022"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

#### ESLint設定

```json
{
  "extends": [
    "next/core-web-vitals",
    "@typescript-eslint/recommended",
    "prettier"
  ],
  "rules": {
    "@typescript-eslint/no-unused-vars": "error",
    "@typescript-eslint/explicit-function-return-type": "warn",
    "prefer-const": "error",
    "no-console": "warn"
  },
  "overrides": [
    {
      "files": ["*.ts", "*.tsx"],
      "rules": {
        "@typescript-eslint/no-explicit-any": "warn"
      }
    }
  ]
}
```

#### Prettier設定

```json
{
  "semi": false,
  "trailingComma": "es5",
  "singleQuote": true,
  "tabWidth": 2,
  "useTabs": false,
  "printWidth": 80,
  "bracketSpacing": true,
  "arrowParens": "avoid",
  "endOfLine": "lf"
}
```

### Git運用ルール

#### ブランチ戦略

```
main (本番環境)
├── develop (開発環境)
│   ├── feature/article-system
│   ├── feature/fanza-integration
│   └── feature/admin-dashboard
├── hotfix/security-patch
└── release/v1.0.0
```

#### コミットメッセージ規約

```
feat: 新機能の追加
fix: バグ修正
docs: ドキュメント更新
style: コードフォーマット
refactor: リファクタリング
test: テスト追加・修正
chore: その他の変更

例:
feat: FANZA API連携機能を追加
fix: 年齢確認ページの表示崩れを修正
docs: README.mdにセットアップ手順を追加
```

---

## 品質保証・テスト

### テスト戦略

#### テストピラミッド

```
E2E Tests (10%)
├── ユーザーフロー全体
├── 重要な機能のテスト
└── ブラウザ互換性テスト

Integration Tests (20%)
├── API連携テスト
├── データベース操作テスト
└── 外部サービス連携テスト

Unit Tests (70%)
├── コンポーネントテスト
├── ユーティリティ関数テスト
└── ビジネスロジックテスト
```

#### テスト実装例

```typescript
// /tests/components/ArticleCard.test.tsx
import { render, screen } from '@testing-library/react'
import { ArticleCard } from '@/components/content/ArticleCard'

const mockArticle = {
  id: '1',
  title: 'テスト記事',
  slug: 'test-article',
  excerpt: 'これはテスト記事です',
  category: 'fuzoku',
  publishedAt: '2025-07-15',
  rating: 4.5,
  viewCount: 1000
}

describe('ArticleCard', () => {
  it('記事情報が正しく表示される', () => {
    render(<ArticleCard article={mockArticle} />)

    expect(screen.getByText('テスト記事')).toBeInTheDocument()
    expect(screen.getByText('これはテスト記事です')).toBeInTheDocument()
    expect(screen.getByText('1,000 views')).toBeInTheDocument()
  })

  it('評価が正しく表示される', () => {
    render(<ArticleCard article={mockArticle} />)

    const ratingElement = screen.getByTestId('article-rating')
    expect(ratingElement).toHaveTextContent('4.5')
  })

  it('カテゴリバッジが表示される', () => {
    render(<ArticleCard article={mockArticle} />)

    const categoryBadge = screen.getByText('風俗体験談')
    expect(categoryBadge).toBeInTheDocument()
  })
})
```

#### E2Eテスト

```typescript
// /tests/e2e/user-flow.spec.ts
import { test, expect } from '@playwright/test'

test.describe('ユーザーフロー', () => {
  test('年齢確認からコンテンツ閲覧まで', async ({ page }) => {
    // 年齢確認ページ
    await page.goto('/')
    await expect(page.getByText('年齢確認')).toBeVisible()

    // 18歳以上を選択
    await page.click('button:has-text("はい（18歳以上）")')

    // トップページに遷移
    await expect(page.getByText('高山まさあきの夜遊び研究所')).toBeVisible()

    // 記事一覧確認
    await expect(page.locator('.article-card')).toHaveCount(5)

    // 記事詳細ページへ遷移
    await page.click('.article-card:first-child')
    await expect(page.getByRole('heading', { level: 1 })).toBeVisible()

    // アフィリエイトリンククリック
    await page.click('.affiliate-link')
    // 新しいタブで開くことを確認
    await expect(page.locator('a[target="_blank"]')).toHaveCount(1)
  })

  test('検索機能', async ({ page }) => {
    await page.goto('/')

    // 検索フォーム入力
    await page.fill('[data-testid="search-input"]', '横浜')
    await page.press('[data-testid="search-input"]', 'Enter')

    // 検索結果確認
    await expect(page.getByText('「横浜」の検索結果')).toBeVisible()
    await expect(page.locator('.article-card')).toHaveCount(3)
  })
})
```

### 品質指標

#### Core Web Vitals目標値

```typescript
// /lib/performance/metrics.ts
export const PERFORMANCE_TARGETS = {
  LCP: 2.5, // Largest Contentful Paint (秒)
  FID: 100, // First Input Delay (ミリ秒)
  CLS: 0.1, // Cumulative Layout Shift
  TTFB: 600, // Time to First Byte (ミリ秒)
  FCP: 1.8, // First Contentful Paint (秒)
}

export function measurePerformance() {
  if (typeof window !== 'undefined') {
    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {
      getCLS(onPerfEntry)
      getFID(onPerfEntry)
      getFCP(onPerfEntry)
      getLCP(onPerfEntry)
      getTTFB(onPerfEntry)
    })
  }
}

function onPerfEntry(metric: any) {
  console.log(metric)

  // アナリティクスに送信
  if (typeof window !== 'undefined' && (window as any).gtag) {
    ;(window as any).gtag('event', metric.name, {
      event_category: 'Web Vitals',
      event_label: metric.id,
      value: Math.round(
        metric.name === 'CLS' ? metric.value * 1000 : metric.value
      ),
      non_interaction: true,
    })
  }
}
```

---

## 監視・分析

### アナリティクス統合

#### Google Analytics 4設定

```typescript
// /lib/analytics/ga4.ts
declare global {
  interface Window {
    gtag: (...args: any[]) => void
  }
}

export const GA_TRACKING_ID = process.env.NEXT_PUBLIC_GA_ID

export function pageview(url: string) {
  if (typeof window !== 'undefined' && window.gtag) {
    window.gtag('config', GA_TRACKING_ID, {
      page_path: url,
    })
  }
}

export function event(action: string, parameters: Record<string, any>) {
  if (typeof window !== 'undefined' && window.gtag) {
    window.gtag('event', action, parameters)
  }
}

// カスタムイベント
export function trackArticleView(articleId: string, category: string) {
  event('article_view', {
    article_id: articleId,
    category: category,
    event_category: 'Article',
  })
}

export function trackAffiliateClick(affiliateType: string, articleId: string) {
  event('affiliate_click', {
    affiliate_type: affiliateType,
    article_id: articleId,
    event_category: 'Affiliate',
  })
}

export function trackSearchQuery(query: string, resultCount: number) {
  event('search', {
    search_term: query,
    result_count: resultCount,
    event_category: 'Search',
  })
}
```

### 収益分析ダッシュボード

```typescript
// /components/admin/RevenueDashboard.tsx
const RevenueAnalytics = () => {
  const [metrics, setMetrics] = useState({
    totalRevenue: 0,
    affiliateClicks: 0,
    conversionRate: 0,
    topPerformingArticles: []
  })

  useEffect(() => {
    const fetchMetrics = async () => {
      // 収益データ取得
      const revenueData = await fetch('/api/analytics/revenue').then(r => r.json())

      // アフィリエイトクリック数
      const { data: clicks } = await supabase
        .from('affiliate_clicks')
        .select('*')
        .gte('clicked_at', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString())

      // コンバージョン率計算
      const conversions = clicks?.filter(c => c.converted).length || 0
      const conversionRate = clicks?.length ? (conversions / clicks.length) * 100 : 0

      // 上位記事取得
      const { data: topArticles } = await supabase
        .from('articles')
        .select('id, title, view_count')
        .order('view_count', { ascending: false })
        .limit(10)

      setMetrics({
        totalRevenue: revenueData.total,
        affiliateClicks: clicks?.length || 0,
        conversionRate,
        topPerformingArticles: topArticles || []
      })
    }

    fetchMetrics()
  }, [])

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <MetricCard
        title="総収益"
        value={`¥${metrics.totalRevenue.toLocaleString()}`}
        change="+12.5%"
        trend="up"
      />
      <MetricCard
        title="アフィリエイトクリック"
        value={metrics.affiliateClicks.toLocaleString()}
        change="+8.2%"
        trend="up"
      />
      <MetricCard
        title="コンバージョン率"
        value={`${metrics.conversionRate.toFixed(1)}%`}
        change="-2.1%"
        trend="down"
      />
      <MetricCard
        title="平均セッション時間"
        value="4:32"
        change="+15.3%"
        trend="up"
      />
    </div>
  )
}
```

### ログ管理

```typescript
// /lib/logging/logger.ts
enum LogLevel {
  DEBUG = 0,
  INFO = 1,
  WARN = 2,
  ERROR = 3,
}

interface LogEntry {
  timestamp: string
  level: LogLevel
  message: string
  meta?: Record<string, any>
  userId?: string
  sessionId?: string
}

class Logger {
  private level: LogLevel = LogLevel.INFO

  constructor(level: LogLevel = LogLevel.INFO) {
    this.level = level
  }

  debug(message: string, meta?: Record<string, any>) {
    this.log(LogLevel.DEBUG, message, meta)
  }

  info(message: string, meta?: Record<string, any>) {
    this.log(LogLevel.INFO, message, meta)
  }

  warn(message: string, meta?: Record<string, any>) {
    this.log(LogLevel.WARN, message, meta)
  }

  error(message: string, error?: Error, meta?: Record<string, any>) {
    this.log(LogLevel.ERROR, message, {
      ...meta,
      error: error?.message,
      stack: error?.stack,
    })
  }

  private log(level: LogLevel, message: string, meta?: Record<string, any>) {
    if (level < this.level) return

    const entry: LogEntry = {
      timestamp: new Date().toISOString(),
      level,
      message,
      meta,
    }

    // 開発環境ではコンソール出力
    if (process.env.NODE_ENV === 'development') {
      console.log(JSON.stringify(entry, null, 2))
    }

    // 本番環境では外部ログサービスに送信
    if (process.env.NODE_ENV === 'production') {
      this.sendToLogService(entry)
    }
  }

  private async sendToLogService(entry: LogEntry) {
    // 実際の実装では外部ログサービス（CloudWatch、Datadog等）に送信
    try {
      await fetch('/api/logs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(entry),
      })
    } catch (error) {
      console.error('Failed to send log entry:', error)
    }
  }
}

export const logger = new Logger(
  process.env.NODE_ENV === 'development' ? LogLevel.DEBUG : LogLevel.INFO
)
```

---

## 結論

**高山まさあきの夜遊び研究所**は、風俗ライターの個人ブランドを確立し、「研究所」という独創的なコンセプトで差別化を図る革新的なアダルトコンテンツサイトです。

### 技術的優位性

- **Next.js 14**の最新機能を活用した高性能サイト
- **Supabase**による拡張性の高いデータベース設計
- **MDX**ベースのリッチなコンテンツ管理システム
- **FANZA API**連携による自動化された収益システム

### 事業的価値

- 実体験に基づく信頼性の高い情報提供
- 読み物としてのエンターテイメント価値
- 効果的なアフィリエイト収益化モデル
- 長期的なブランド資産の構築

### 運用の持続可能性

- 自動化されたコンテンツ管理システム
- 包括的な監視・分析システム
- 法的コンプライアンスの確保
- セキュリティ・パフォーマンスの最適化

この設計書に基づいて実装することで、**takayamalog.com**は単なるアダルトサイトを超えた、読者に価値を提供し続ける持続可能なメディアサイトとして成長できます。

---

_高山まさあきの夜遊び研究所 設計書v1.0_  
_作成日: 2025年7月9日_  
_プロジェクト: takayamalog.com_  
_文字数: 約20,000字_
